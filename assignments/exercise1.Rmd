---
title: "Exercise 1"
author: "Tarini Sudhakar"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(rsample)
library(caret)
library(foreach)
library(modelr)
```

## Data visualization: flights at ABIA

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Wrangling the Olympics

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

##  K-nearest neighbors: cars
```{r knn}
sclass <- read.csv("~/Documents/Coding/ECO395M-DataMining/data/sclass.csv")
set.seed(1720104007)

#Filter for 350
car350 <- sclass %>%
  filter(trim == 350)

#Split train/test for 350
car350_split = initial_split(car350, prop=0.8)
car350_train = training(car350_split)
car350_test  = testing(car350_split)
```

## K=2
```{r 350k=2}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 2) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base = ggplot(data = car350) + 
  geom_point(mapping = aes(x = mileage, y = price), color='darkgrey') + 
  theme_bw(base_size=10) 
p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)

```


## K=5
```{r 350k=5}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 5) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)

```


## K=10
```{r 350k=10}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 10) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)

```


## K=20
```{r 350k=20}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 20) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)

```

## K=30
```{r 350k=30}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 30) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)

```


## K=50
```{r 350k=50}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 50) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)
```


## K=70
```{r 350k=70}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 70) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)
```


## K=100
```{r 350k=100}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 100) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)
```

## K=150
```{r 350k=150}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 150) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)
```

## K=300
```{r 350k=300}
knn_model = knnreg(price ~ mileage, data=car350_train, k = 300) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)
```

## K-nearest neighbors: test  

```{r, fig.width=4, fig.asp = 0.6, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}

k_grid = unique(round(exp(seq(log(332), log(2), length=300))))
rmse_grid_out = foreach(k = k_grid, .combine='c') %do% {
  knn_model = knnreg(price ~ mileage,
                     data = car350_train, k = k)
  modelr::rmse(knn_model, car350_test)
}

rmse_grid_out = data.frame(K = k_grid, RMSE = rmse_grid_out)

revlog_trans <- function(base = exp(1)) {
  require(scales)
  ## Define the desired transformation.
  trans <- function(x){
    -log(x, base)
  }
  ## Define the reverse of the desired transformation
  inv <- function(x){
    base^(-x)
  }
  ## Creates the transformation
  scales::trans_new(paste("revlog-", base, sep = ""),
                    trans,
                    inv,  ## The reverse of the transformation
                    log_breaks(base = base), ## default way to define the scale breaks
                    domain = c(1e-100, Inf) 
  )
}

p_out = ggplot(data=rmse_grid_out) + 
  theme_bw(base_size = 10) + 
  geom_path(aes(x=K, y=RMSE, color='testset'), size=0.5) + 
  scale_x_continuous(trans=revlog_trans(base = 10)) 

ind_best = which.min(rmse_grid_out$RMSE)
k_best = k_grid[ind_best]

rmse_grid_in = foreach(k = k_grid, .combine='c') %do% {
  knn_model = knnreg(price ~ mileage,
                     data = car350_train, k = k)
  modelr::rmse(knn_model, car350_train)
}

rmse_grid_in = data.frame(K = k_grid, RMSE = rmse_grid_in)

p_out + geom_path(data=rmse_grid_in, aes(x=K, y=RMSE, color='trainset'),size=0.5) +
  scale_colour_manual(name="RMSE",
    values=c(testset="black", trainset="grey")) + 
  geom_vline(xintercept=k_best, color='darkgreen', size=1)
```


## K-nearest neighbors: at the optimal k  

```{r, fig.width=4, fig.asp = 0.6, fig.align='center', echo=FALSE, message=FALSE}
knn_model = knnreg(price ~ mileage,
                   data = car350_train, k = k_best)

knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car350_test)
```

``` {r knn65}

#Filter for 65 AMG
car65AMG <- sclass %>%
  filter(trim == '65 AMG')

#Split train/test for 65 
car65_split = initial_split(car65AMG, prop=0.8)
car65_train = training(car65_split)
car65_test  = testing(car65_split)

```

## K=2
```{r 65k=2}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 2) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base = ggplot(data = car65AMG) + 
  geom_point(mapping = aes(x = mileage, y = price), color='darkgrey') + 
  theme_bw(base_size=10) 
p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)

```

## K=5
```{r 65k=5}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 5) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)

```


## K=10
```{r 65k=10}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 10) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)

```


## K=20
```{r 65k=20}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 20) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)

```

## K=30
```{r 65k=30}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 30) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)

```


## K=50
```{r 65k=50}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 50) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)
```


## K=70
```{r 65k=70}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 70) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)
```


## K=100
```{r 65k=100}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 100) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)
```

## K=150
```{r 65k=150}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 150) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)
```

## K=200
```{r 65k=300}
knn_model = knnreg(price ~ mileage, data=car65_train, k = 200) 
knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)
```


## K-nearest neighbors: test  

```{r, fig.width=4, fig.asp = 0.6, fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}

k_grid = unique(round(exp(seq(log(233), log(2), length=200))))
rmse_grid_out = foreach(k = k_grid, .combine='c') %do% {
  knn_model = knnreg(price ~ mileage,
                     data = car65_train, k = k)
  modelr::rmse(knn_model, car65_test)
}

rmse_grid_out = data.frame(K = k_grid, RMSE = rmse_grid_out)

p_out = ggplot(data=rmse_grid_out) + 
  theme_bw(base_size = 10) + 
  geom_path(aes(x=K, y=RMSE, color='testset'), size=0.5) + 
  scale_x_continuous(trans=revlog_trans(base = 10)) 

ind_best = which.min(rmse_grid_out$RMSE)
k_best = k_grid[ind_best]

rmse_grid_in = foreach(k = k_grid, .combine='c') %do% {
  knn_model = knnreg(price ~ mileage,
                     data = car65_train, k = k)
  modelr::rmse(knn_model, car65_train)
}

rmse_grid_in = data.frame(K = k_grid, RMSE = rmse_grid_in)

p_out + geom_path(data=rmse_grid_in, aes(x=K, y=RMSE, color='trainset'),size=0.5) +
  scale_colour_manual(name="RMSE",
    values=c(testset="black", trainset="grey")) + 
  geom_vline(xintercept=k_best, color='darkgreen', size=1)
```

## K-nearest neighbors: at the optimal k  

```{r, fig.width=4, fig.asp = 0.6, fig.align='center', echo=FALSE, message=FALSE}
knn_model = knnreg(price ~ mileage,
                   data = car65_train, k = k_best)

knn_pred = function(x) {
  predict(knn_model, newdata=data.frame(mileage=x))
}

p_base + stat_function(fun=knn_pred, color='red', size=1.5, n=1001)

modelr::rmse(knn_model, car65_test)
```